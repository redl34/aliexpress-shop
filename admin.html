<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель адміністратора - Ali.Reed</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="images/favicon.png" rel="icon" type="image/png"/>
    <style>
        /* Ваш поточний CSS без змін */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .modal-content button {
            margin: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
        }
        .modal-content button.confirm {
            background-color: #e63946;
            color: white;
        }
        .modal-content button.cancel {
            background-color: #6EA9D8;
            color: white;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js" type="module"></script>
</head>
<body>
    <div class="container">
        <h1>Панель адміністратора</h1>
        <a class="home-link" href="index.html">Повернутися на головну</a>
        <a class="logout-link" href="#" id="logoutLink">Вийти</a>
        <div class="search-container">
            <input id="searchInput" placeholder="Пошук за артикулом або назвою" type="text"/>
            <button onclick="searchProducts()">Пошук</button>
        </div>
        <div>
            <label for="checkTime">Час перевірки товарів:</label>
            <input type="time" id="checkTime" />
            <button onclick="saveCheckTime()">Зберегти час</button>
        </div>
        <h2>Товари</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Артикул</th>
                    <th>Назва</th>
                    <th>Ціна на сайті</th>
                    <th>Ціна на AliExpress</th>
                    <th>Статус</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody id="productTable"></tbody>
        </table>
        <h2>Ціна товару</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Артикул</th>
                    <th>Ціна</th>
                    <th>Дата зміни</th>
                </tr>
            </thead>
            <tbody id="priceTable"></tbody>
        </table>
        <h2>Товари на видалення</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Артикул</th>
                    <th>Назва</th>
                    <th>Опис</th>
                    <th>Дата помилки</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody id="toDeleteTable"></tbody>
        </table>
    </div>
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <p>Ви впевнені, що хочете видалити товар?</p>
            <button class="confirm" onclick="confirmDelete()">Так, видалити</button>
            <button class="cancel" onclick="closeModal()">Відмінити</button>
        </div>
    </div>
    <footer>
        <!-- Ваш поточний футер -->
    </footer>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, updateDoc, doc, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAGzhOScgX59UvDxFffw xPRx9YqYAaqGj-Q",
            authDomain: "alishopping-ced60.firebaseapp.com",
            projectId: "alishopping-ced60",
            storageBucket: "alishopping-ced60.firebasestorage.app",
            messagingSenderId: "869364972631",
            appId: "1:869364972631:web:f9b736868d9844b3e7f712",
            measurementId: "G-SF4MY2768F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let deleteDocId = null;

        // Перевірка авторизації
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                alert('У вас немає прав адміністратора.');
                await signOut(auth);
                window.location.href = 'login.html';
            }
        });

        // Вихід
        document.getElementById('logoutLink').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'login.html';
        });

        // Завантаження товарів
        async function loadProducts() {
            const productTable = document.getElementById('productTable');
            const priceTable = document.getElementById('priceTable');
            const toDeleteTable = document.getElementById('toDeleteTable');

            // Товари
            const productsSnapshot = await getDocs(collection(db, 'products'));
            productTable.innerHTML = '';
            productsSnapshot.forEach(doc => {
                const product = doc.data();
                if (product.status !== 'deleted') {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.articul}</td>
                        <td>${product.title}</td>
                        <td><input type="number" value="${product.price}" id="price_${product.articul}"></td>
                        <td>${product.aliexpressPrice || 'Н/Д'}</td>
                        <td>${product.status || 'Н/Д'}</td>
                        <td>
                            <button class="edit" onclick="updatePrice('${doc.id}', '${product.articul}')">Зберегти</button>
                            <button class="delete" onclick="openDeleteModal('${doc.id}')">Видалити</button>
                        </td>
                    `;
                    productTable.appendChild(row);
                }
            });

            // Ціни
            const priceSnapshot = await getDocs(collection(db, 'price_changes'));
            priceTable.innerHTML = '';
            priceSnapshot.forEach(doc => {
                const price = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${price.articul}</td>
                    <td>${price.price}</td>
                    <td>${price.updatedAt.toDate().toLocaleDateString()}</td>
                `;
                priceTable.appendChild(row);
            });

            // Товари на видалення
            const toDeleteSnapshot = await getDocs(collection(db, 'products_to_delete'));
            toDeleteTable.innerHTML = '';
            toDeleteSnapshot.forEach(doc => {
                const product = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.articul}</td>
                    <td>${product.title}</td>
                    <td>${product.description}</td>
                    <td>${product.errorDate.toDate().toLocaleDateString()}</td>
                    <td><button class="delete" onclick="openDeleteModal('${doc.id}')">Видалити</button></td>
                `;
                toDeleteTable.appendChild(row);
            });
        }

        // Оновлення ціни
        window.updatePrice = async function(docId, articul) {
            const newPrice = document.getElementById(`price_${articul}`).value;
            await updateDoc(doc(db, 'products', docId), { price: parseFloat(newPrice) });
            await addDoc(collection(db, 'price_changes'), {
                articul,
                price: parseFloat(newPrice),
                updatedAt: new Date()
            });
            alert('Ціну оновлено!');
            loadProducts();
        };

        // Відкриття модального вікна для видалення
        window.openDeleteModal = function(docId) {
            deleteDocId = docId;
            document.getElementById('deleteModal').style.display = 'flex';
        };

        // Закриття модального вікна
        window.closeModal = function() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteDocId = null;
        };

        // Підтвердження видалення
        window.confirmDelete = async function() {
            if (deleteDocId) {
                await deleteDoc(doc(db, 'products', deleteDocId));
                await addDoc(collection(db, 'deleted_products'), {
                    articul: (await getDoc(doc(db, 'products', deleteDocId))).data().articul,
                    deletedAt: new Date()
                });
                alert('Товар видалено!');
                closeModal();
                loadProducts();
            }
        };

        // Збереження часу перевірки
        window.saveCheckTime = async function() {
            const checkTime = document.getElementById('checkTime').value;
            await setDoc(doc(db, 'settings', 'checkTime'), { time: checkTime });
            alert('Час перевірки збережено!');
            // Викликати сервер для оновлення CRON
        };

        // Пошук товарів
        window.searchProducts = function() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#productTable tr');
            rows.forEach(row => {
                const articul = row.cells[0].textContent.toLowerCase();
                const title = row.cells[1].textContent.toLowerCase();
                row.style.display = (articul.includes(searchInput) || title.includes(searchInput)) ? '' : 'none';
            });
        };

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        loadProducts();
    </script>
</body>
</html>